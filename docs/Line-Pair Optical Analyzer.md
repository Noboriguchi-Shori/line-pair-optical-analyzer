
---

# 1. ソフトウェア詳細仕様書 (Software Specification)

**ドキュメント名:** Line-Pair Optical Analyzer 詳細仕様書
**バージョン:** 1.1
**対象:** 開発者、技術管理者、保守担当者

## 1.1. 概要

本ソフトウェアは、ラインスキャンカメラやリニアイメージセンサで取得した「ラインペアチャート（白黒の縞模様）」の輝度プロファイルを解析するためのツールである。CSVデータを読み込み、信号処理フィルタ、エッジ検出、MTF解析を行い、画像の品質（コントラスト、均一性、直線性など）を定量評価する。

## 1.2. 動作環境

* **OS:** Windows 10/11 (推奨), Linux, macOS
* **言語:** Python 3.8以上
* **依存ライブラリ:**
* `tkinter` (GUI)
* `pandas` (データ操作)
* `numpy` (数値計算)
* `matplotlib` (グラフ描画)
* `scipy` (信号処理・FFT)



## 1.3. 入出力仕様

### 1.3.1. 入力データ

* **形式:** CSVファイル (`.csv`)
* **構造:** ヘッダーなし、第1列目に輝度データ（0-255等の数値）が連続して並んでいること。
* **欠損値:** 自動的に除去（dropna）して処理する。

### 1.3.2. 出力データ

* **形式:** CSVファイル (`result_[元ファイル名].csv`)
* **エンコーディング:** UTF-8 (BOM付き/utf-8-sig) ※Excelでの文字化け防止
* **内容:** 検出された各ラインペアごとの解析指標一覧（ID, 位置, ピッチ, コントラスト, リニアリティ誤差など）。

## 1.4. 機能仕様

### 1.4.1. 信号処理フィルタ

パラメータ `p1` は全て「画素数 (px)」単位で正規化して処理を行う。

| フィルタ種類 | アルゴリズム | パラメータ(p1)の意味 | 用途 |
| --- | --- | --- | --- |
| **Lowpass** | 4次Butterworth | カットオフ周期 [px] | 高周波ノイズ（指定pxより細かい波）の除去 |
| **Highpass** | 4次Butterworth | カットオフ周期 [px] | 低周波ムラ（シェーディング等）の除去 |
| **Moving Average** | 移動平均畳み込み | ウィンドウ幅 [px] | ランダムノイズの平滑化 |
| **Median** | メディアンフィルタ | ウィンドウ幅 [px] | スパイクノイズ（ごま塩ノイズ）の除去 |
| **Gaussian** | ガウシアンフィルタ | シグマ() [px] | 自然なぼかし処理 |

### 1.4.2. 解析アルゴリズム

1. **二値化処理:**
* ユーザー指定のしきい値（Threshold）を超えた部分を`1`、以下を`0`とする。


2. **エッジ検出:**
* `0→1` を立ち上がり（Rise）、`1→0` を立ち下がり（Fall）として概略位置を特定。


3. **サブピクセル推定:**
* 概略位置の前後のデータを用いて線形補間を行い、しきい値と交差する正確な浮動小数点座標を算出する。


4. **ペアリング:**
* 「立ち上がり」→「立ち下がり」→「次の立ち上がり」を1つの周期（ラインペア）として認識。


5. **輝度取得:**
* 白部：立ち上がり～立ち下がりの区間平均
* 黒部：立ち下がり～次立ち上がりの区間平均



### 1.4.3. 評価指標定義

* **Pitch (ピッチ):** 隣接する立ち上がりエッジ間の距離 [px]。
* **Contrast (コントラスト):**  で算出（マイケルソン・コントラスト）。
* **Linearity (黒位置ズレ):**
* 全ラインペアの黒ライン中心位置座標を取得。
* 最小二乗法により理想直線（）を算出。
* `実測値 - 理想値` を誤差として算出。
* 値が0に近いほど、等間隔かつ直線的に並んでいることを示す。


* **MTF/FFT:**
* FFTによる空間周波数スペクトルを表示。
* MTFグラフにて、空間周波数に対するコントラスト応答をプロット。



## 1.5. UI仕様

* **メインウィンドウ:** 1650x1000 px
* **サイドバー:** 左側に配置。ファイル操作、パラメータ設定、サマリー表示を行う。
* **グラフエリア:**
1. **Profile:** 生データ、フィルタ後データ、しきい値線。
2. **Diff:** 輝度の微分（エッジ強度）。
3. **FFT:** 周波数解析結果。
4. **MTF:** 周波数 vs コントラスト。
5. **Trend:** 各ラインペアごとの指標推移（X軸: ID, Y軸: 選択項目）。


* **テーブル:** 下部に全データの数値をリスト表示。

---

# 2. 取扱説明書 (User Manual)

**ドキュメント名:** Line-Pair Optical Analyzer 取扱説明書
**バージョン:** 1.1
**対象:** ユーザー（光学エンジニア、検査担当者）

## 2.1. はじめに

本ソフトウェアは、カメラ画像の輝度データ（CSV）を読み込み、レンズやセンサーの性能（解像力、均一性、歪みなど）を評価するためのツールです。特にラインスキャンカメラのチャート評価に適しています。

## 2.2. 画面構成

画面は大きく分けて3つのエリアで構成されています。

1. **左サイドバー:** ファイル読み込みや設定を行う操作パネル。
2. **右側グラフエリア:** データの波形や解析結果をグラフ表示するエリア。
3. **下部テーブル:** 解析された数値を一覧表示するエリア。

## 2.3. 基本的な使い方

### 手順1: データの読み込み

1. 左上の **「📂 CSVファイルを開く」** ボタンをクリックします。
2. 解析したいCSVファイルを選択します。
* ※ CSVは「1列目に輝度数値が並んでいる」形式である必要があります。


3. 読み込みが完了すると、自動的にグラフと解析結果が表示されます。

### 手順2: しきい値の調整

波形に対して、正しく「白」と「黒」を分離できているか確認します。

* メイングラフ（右上段）の **赤の点線** がしきい値です。
* **「2. 解析パラメータ」** の「二値化しきい値」スライダーを動かし、波形の上下中心付近に来るように調整してください。
* **「判定ガイドを表示」** にチェックを入れると、認識されたエッジ位置に緑と赤の線が表示されます。これが波形とズレていないか確認してください。

### 手順3: フィルタの適用（ノイズが多い場合）

波形がギザギザしていて誤検出する場合は、フィルタを使用します。

1. **「1. 信号処理フィルタ」** のプルダウンから種類を選択します（例: `Lowpass`）。
2. **「フィルタ詳細設定」** を押し、数値を調整します。
* 例: 「10」と入力 → 幅10ピクセル以下の細かいノイズを除去します。



### 手順4: 解析結果の確認

* **解析サマリー:** 左サイドバー下部のテキストボックスに、平均ピッチやコントラスト、黒位置の直線性が表示されます。
* **トレンドグラフ:** 右下段のグラフで、画像左端から右端にかけての品質変化を確認できます。
* **「3. グラフ表示オプション」** → **「📈 メイングラフ設定」** で、表示したい項目（コントラスト、ピッチなど）を切り替えられます。



### 手順5: データの保存

解析結果をExcelなどで使いたい場合は、左下の **「💾 解析結果をCSV保存」** ボタンを押して保存してください。

## 2.4. 用語・機能解説

### 評価項目 (Metrics)

| 項目名 | 意味 | 理想的な状態 |
| --- | --- | --- |
| **ピッチ (Pitch)** | 白黒ペアの幅（画素数）。倍率の指標。 | 全体で一定であること |
| **コントラスト (Contrast)** | 白と黒の輝度差の明瞭さ(0.0～1.0)。 | 1.0に近いほど良い |
| **黒位置ズレ (Linearity)** | 黒ラインが等間隔・直線からどれだけズレているか。 | **0.0に近いほど良い**。値が大きい＝歪曲や送りムラがある |
| **Duty比** | 1周期に対する白の割合。 | チャートによる（通常50%） |
| **Dark Shade** | 暗部（黒）の均一性。 | 平坦である（バラつきがない）こと |

### 直線性 (Linearity) について

v1.1で追加された機能です。チャート上の黒線が物理的に等間隔で並んでいる前提で、カメラ画像上でそれが一直線（または一定の変化）になっているかを判定します。

* グラフが「U字」になる場合: レンズの歪曲収差の可能性があります。
* グラフが「ギザギザ」する場合: 搬送系の振動やエンコーダの不整の可能性があります。

### トレンド詳細ウィンドウ

「📊 新規トレンド窓を追加」ボタンを押すと、グラフだけを別ウィンドウで表示できます。複数のモニタで異なる指標（例：ウィンドウ1でコントラスト、ウィンドウ2でピッチ）を同時に監視したい場合に便利です。

## 2.5. トラブルシューティング

* **Q. グラフが表示されない / "検出数: 0" となる**
* A. しきい値が適切ではありません。「二値化しきい値」を調整し、赤い点線が波形と交差するようにしてください。「↩ しきい値を平均値に戻す」ボタンを押すと改善することが多いです。


* **Q. ノイズでエッジが大量に検出されてしまう**
* A. フィルタ（Lowpassなど）を強めにかけてください。または、CSVデータ自体に高周波ノイズが乗りすぎていないか確認してください。


* **Q. Excelで保存したCSVを開くと文字化けする**
* A. 本ソフトは「BOM付きUTF-8」で保存しているため、通常はそのまま開けます。古いExcelの場合は「データのインポート」からUTF-8を指定して開いてください。

---

# 評価項目詳細ガイド

本ソフトウェアでは、ラインスキャンカメラ等の画像から得られた輝度プロファイルを解析し、以下の4つのカテゴリで評価を行います。

1. **基本輝度・コントラスト** (明るさとメリハリ)
2. **形状・幾何学特性** (サイズと並びの正確さ)
3. **エッジ・波形品質** (ピントと信号の質)
4. **均一性・ノイズ** (画面全体の一様さ)

---

## 1. 基本輝度・コントラスト

チャートの白線（明部）と黒線（暗部）の明るさと、その分離能力に関する指標です。

### **High (High輝度)**

* **定義:** 各ラインペアにおける白線部分（明部）の平均輝度値。
* **単位:** 階調 (Digital Number, e.g., 0-255)
* **診断:**
* 低すぎる場合: 露光不足、照明光量不足、ゲイン不足。
* 255(飽和)付近の場合: 露光過多（白飛び）。正しい解析ができないため、絞りや照明を調整する必要があります。



### **Low (Low輝度)**

* **定義:** 各ラインペアにおける黒線部分（暗部）の平均輝度値。
* **単位:** 階調
* **診断:**
* 高すぎる場合: 黒浮き（オフセット設定のミス）、迷光（フレア/ゴースト）、または照明の当て方が悪く黒に光が回り込んでいる可能性。



### **Contrast (コントラスト / Modulation)**

* **定義:** 明部と暗部の分離度合いを表す最も重要な指標（マイケルソン・コントラスト）。
* **計算式:** 
* **範囲:** 0.0 ～ 1.0
* **診断:**
* **MTF (Modulation Transfer Function)** の値そのものです。
* 値が低い場合: ピンボケ、レンズの解像力不足、センサのクロストーク、または周波数（チャートの細かさ）が限界を超えています。



### **Ratio (コントラスト比)**

* **定義:** 明部と暗部の単純な比率。
* **計算式:** 
* **単位:** 倍率
* **用途:** 印刷業界やバーコード検証などで用いられることがあります。Lowが0に近いと無限大になるため、解析上の安定性はContrastの方が優れています。

---

## 2. 形状・幾何学特性

被写体の「形」が正しく撮像できているかを表す指標です。

### **Pitch (ピッチ)**

* **定義:** 「ある白線の開始位置」から「次の白線の開始位置」までの距離。
* **単位:** px (ピクセル)
* **診断:**
* 光学倍率（マグニフィケーション）を示します。
* 画面中央と周辺で値が大きく異なる場合、レンズの**歪曲収差（ディストーション）**が疑われます。



### **Duty (Duty比)**

* **定義:** 1周期（ピッチ）のうち、白線（明部）が占める割合。
* **計算式:** 
* **単位:** %
* **診断:**
* 通常、等間隔チャートであれば **50%** が理想です。
* 大きくズレる場合: 二値化しきい値の設定ミス、または照明が強すぎて白が膨張している（ブルーミング）可能性があります。



### **Distortion (歪曲偏差 / 局所倍率誤差)**

* **定義:** その位置のピッチが、全体の「平均ピッチ」から何%ズレているか。
* **計算式:** 
* **単位:** %
* **診断:**
* **レンズの歪み**を定量化します。
* プラス値は拡大（糸巻き型傾向）、マイナス値は縮小（樽型傾向）を示唆しますが、ラインセンサの場合はスキャン速度ムラの影響も受けます。



### **Linearity (黒位置ズレ / 直線性)** [v1.1追加]

* **定義:** 全ラインペアの黒線中心位置をプロットし、理想直線（回帰直線）からどれだけ位置がズレているか。
* **単位:** px
* **診断:**
* **0に近いほど良い**状態です。
* **U字/逆U字:** レンズの歪曲収差の影響。
* **周期的/ランダム:** 搬送系（コンベア・ステージ）の速度ムラ、振動、エンコーダ信号の不正。
* **Distortionとの違い:** Distortionは「隣との間隔」を見るのに対し、Linearityは「絶対的な位置の並び」を見ます。



### **Jitter (隣接誤差)**

* **定義:** 一つ前のラインペアとのピッチ差の絶対値。
* **計算式:** 
* **単位:** px
* **診断:**
* 突発的な振動や、電気的な同期信号の乱れ（ジッター）を検出します。



---

## 3. エッジ・波形品質

ピントの鋭さや、信号処理系の質を表す指標です。

### **Rise_px (立上り幅)**

* **定義:** 黒から白へ遷移する際、輝度差の10%地点から90%地点まで変化するのに要した距離。
* **単位:** px
* **診断:**
* 値が**小さいほどシャープ**（ピントが合っている）です。
* レンズ性能の限界や、ローパスフィルタの効きすぎで大きくなります。



### **Fall_px (立下り幅)**

* **定義:** 白から黒へ遷移する際の10%-90%遷移幅。
* **単位:** px
* **診断:** Rise_pxと同様。通常はRiseと同じような値になります。

### **Asymmetry (非対称性)**

* **定義:** 立上り幅と立下り幅の差。
* **計算式:** 
* **単位:** px
* **診断:**
* 値が大きい場合: **片ボケ**、またはセンサの読み出し方向（転送効率）に起因する「尾引き」が発生している可能性があります。



### **Slope (エッジ傾斜度)**

* **定義:** エッジの急峻さ。Rise_pxの逆数に近い概念。
* **計算式:** 
* **診断:** 値が大きいほどエッジが立っており、良好です。

### **Overshoot (オーバーシュート)**

* **定義:** エッジの直後で、平均輝度を超えて跳ね上がっている量。
* **計算式:** 
* **単位:** %
* **診断:**
* カメラ内部の「エッジ強調（シャープネス）」処理が強すぎる場合や、アナログ信号伝送路のインピーダンス不整合などで発生します。



---

## 4. 均一性・ノイズ

画面全体、あるいは信号自体の安定性を表す指標です。

### **Shading (明部相対輝度 / シェーディング)**

* **定義:** その位置のHigh輝度が、データ全体の最大High輝度に対して何%か。
* **計算式:** 
* **単位:** %
* **診断:**
* 周辺部で数値が下がる場合、**周辺減光**（レンズ特性または照明の配光特性）を示します。
* いわゆる「シェーディング補正」が必要かどうかの判断に使います。



### **Dark Shade (暗部均一性)**

* **定義:** その位置のLow輝度が、データ全体の平均Low輝度に対して何%か。
* **計算式:** 
* **単位:** %
* **診断:**
* 黒レベルのムラを見ます。
* 特定箇所だけ高い場合、センサ上のゴミ、キズ、または外部からの迷光漏れが疑われます。



### **SNR (信号対雑音比)**

* **定義:** 白線（明部）平坦部における「平均値」と「標準偏差（バラつき）」の比。
* **計算式:** 
* **単位:** dB (デシベル)
* **診断:**
* 値が高いほどノイズが少なくクリアな画像です。
* ゲイン（ISO感度）を上げすぎるとSNRは低下します。
* 照明のチラつき（リップル）がある場合も低下します。